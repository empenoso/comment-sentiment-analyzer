{
  "url": "https://t-j.ru/guide/excel-kotirovki/",
  "article_id": "cbc75a80-1a5e-440b-ad13-bf2295ae592d",
  "article_uuid": "cbc75a80-1a5e-440b-ad13-bf2295ae592d",
  "title": "Учет инвестиций в Excel: как скачивать таблицы котировок с бирж и финансовых агрегаторов",
  "comments": [
    {
      "id": 1957699,
      "author": "denis",
      "datetime": "2024-04-19T16:48:59.012305+03:00",
      "text": "Было бы удобно заполнить весь первый лист списком A:Тикер B:Цена, а затем искать уже в нем. Тогда можно брать цены из простых текстовых файлов скаченных откуда удобно, или сохраненных из программ, с любым порядком и списком тикеров."
    },
    {
      "id": 1957703,
      "author": "Михаил Шардин",
      "datetime": "2024-04-19T16:50:50.394592+03:00",
      "text": "denis, хорошая идея! \nМожет быть в следующей версии так и будет"
    },
    {
      "id": 1957770,
      "author": "Alexander",
      "datetime": "2024-04-19T17:27:39.653713+03:00",
      "text": "&gt;&gt; Как в «Экселе» получать цены облигаций через API Мосбиржи\nВ примере режим торгов  TQOB -- для гособлигаций, для обычных  заменить TQOB на TQCB\n\nСправка по режимам https://iss.moex.com/iss/engines/stock/markets/bonds/boards.xml"
    },
    {
      "id": 1958081,
      "author": "Благоустройство со сносом",
      "datetime": "2024-04-19T20:34:47.381379+03:00",
      "text": "Аааааааа котировки котировки"
    },
    {
      "id": 1968256,
      "author": "Алексей",
      "datetime": "2024-04-24T17:42:04.554007+03:00",
      "text": "denis, эту очевидную хотелку никто не может сделать уже много лет. :)"
    },
    {
      "id": 1982810,
      "author": "Юрий Дурицкий",
      "datetime": "2024-05-02T17:12:54.849943+03:00",
      "text": "Добрый день. Есть формула котировок корп.облигаций? заранее благодарен."
    },
    {
      "id": 1995732,
      "author": "Михаил Лебедев",
      "datetime": "2024-05-08T12:18:50.818789+03:00",
      "text": "Когда функция ФИЛЬТР.XML получает значение вида \"1.2345\" она может в соответствии с региональными стандартами подумать что это дата, в итоге вы получите безумно большое число вместо \"1.2345\"\nНа такой случай может понадобится ещё одно преобразование:\n=ТЕКСТ(@ФИЛЬТР.XML(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/shares/boards/\"&amp;B2&amp;\"/securities.xml?iss.meta=off&amp;iss.only=marketdata&amp;marketdata.columns=SECID,LAST\");\"//document//data//rows//row[@SECID='\"&amp;C2&amp;\"']//@LAST\");\"#,#\")"
    },
    {
      "id": 1998102,
      "author": "LOnly",
      "datetime": "2024-05-09T17:59:14.025284+03:00",
      "text": "Михаил, огромное спасибо за Exсel файл с примерами! Искал. Теперь есть с чего начать свои собственные эксперименты."
    },
    {
      "id": 1998115,
      "author": "Михаил Шардин",
      "datetime": "2024-05-09T18:04:48.649140+03:00",
      "text": "LOnly, рад что смог помочь"
    },
    {
      "id": 2001663,
      "author": "Владимир Т.",
      "datetime": "2024-05-12T15:26:14.108511+03:00",
      "text": "Добрый день! Для получения данных по корпоративным облигациям по Вашей формуле замена режима торгов на TQCB ничего не дает. При запросе купона выходит #ЗНАЧ!\n=ПОДСТАВИТЬ(@ ФИЛЬТР.XML(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities.xml?iss.meta=off&amp;iss.only=securities&amp;securities.columns=SECID,COUPONVALUE\");\"//document//data//rows//row[@SECID='\"&amp;D19&amp;\"']/@COUPONVALUE\");\".\";\",\")\nЕсли же формулу поменять на\n=ПОДСТАВИТЬ(@ФИЛЬТР.XML(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities/\"&amp;D19&amp;\"/securities.xml?iss.meta=off&amp;iss.only=securities&amp;securities.columns=COUPONVALUE\");\"//document//data//rows//row/@COUPONVALUE\");\".\";\",\")\nданные по купону выдает, но при разных ISIN может выдать адекватные данные, а может типа 16681. То же и с НКД. Остальные данные (дата погашения, дата купона, доходность, ...) получаются правильные.\nПри этом запросы в ГУГЛ таблицах выдают правильную информацию.\n=IMPORTxml(\"https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities.xml?iss.meta=off&amp;iss.only=securities&amp;securities.columns=SECID,COUPONVALUE\", СЦЕПИТЬ(\"//row[@SECID='\",A7,\"']/@COUPONVALUE\"))\nС чем это может быть связано и как решить проблему?"
    },
    {
      "id": 2003215,
      "author": "Михаил Шардин",
      "datetime": "2024-05-13T12:31:07.323899+03:00",
      "text": "Владимир, я Вам подскажу.\n\nНапример для корпоративной облигации RU000A106946 получение цены на вчера в Экселе:\n\n=ПОДСТАВИТЬ(@ ФИЛЬТР.XML(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities/\"&amp;D19&amp;\"/securities.xml?iss.meta=off&amp;iss.only=securities&amp;securities.columns=SECID,PREVLEGALCLOSEPRICE\");\"//document//data//rows//row/@PREVLEGALCLOSEPRICE\");\".\";\".\")"
    },
    {
      "id": 2004509,
      "author": "Владимир Т.",
      "datetime": "2024-05-14T05:18:00.200353+03:00",
      "text": "Спасибо, Михаил! \nЯ обратил внимание, что про корпоратов Вы не писали. Пытался разобраться почему формула из статьи, подходящая для ОФЗ, не срабатывает для других облигаций и надо использовать другой ее вид. И удивило, что запросы из Excel и Google к API Мосбиржи могут выдавать разные результаты. Возможно, проблема в Excel."
    },
    {
      "id": 2074279,
      "author": "Алексей Демченко",
      "datetime": "2024-06-17T16:41:19.047731+03:00",
      "text": "Сегодня перестали работать функции Ексель 365 по работе с акциями( Попробовал методами, описанными в статье - получилось! Спасибо! Как водится, но... Не работает с ETF. Н-р SBMX, TMOS. Также необъяснимый косяк с получением котировок IRAO, SVCB и UPRO, причем очень выборочно (в отношении более 50 позиций моего списка в целом корректно работает).\nАкции\t\t\nТикер\tЦена сегодня\tЦена вчера\nLKOH\t7269\t7393\nSBER\t318,82\t320,29\nIRAO\t2507451\t33298\nSVCB\t17,965\t45340\nUPRO\t45293\t2,018"
    },
    {
      "id": 2076478,
      "author": "Елена Демидова",
      "datetime": "2024-06-18T17:26:24.020085+03:00",
      "text": "Раньше в Office 365 данные подтягивались через встроенные функции excel. Но с введением санкций в отношении Мосбиржи (с этих выходных), возможность пропала. И тут вопрос уже не ВПН, а что просто больше нет связи Office и Мосбиржи.\n\nВот, ищу альтернативные пути. Ваш (импорт в Excel из XML Мосбиржи) очень интересен. Тем более он может подтащить всё, что мне раньше грузил Office, и даже немного больше.\n\nДавно смотрю в сторону Tinkoff.API, чтобы ещё автоматизировать и информацию о сделках, и выставление приказов (у меня в Excel зашита логика покупки/продажи). Но пока нет времени на изучение."
    },
    {
      "id": 2076492,
      "author": "Елена Демидова",
      "datetime": "2024-06-18T17:31:54.533648+03:00",
      "text": "Алексей, да, аналогичный косяк замечен по:\nIRAO\nLSNG\nNMTP\nCNTL\nCNTLP\nPRFN\n\nА UPRO и SVCB у меня нормально отрабатывает..."
    },
    {
      "id": 2076503,
      "author": "Елена Демидова",
      "datetime": "2024-06-18T17:36:31.370010+03:00",
      "text": "Алексей, кстати, вон, выше решение вопроса от Михаила Лебедева."
    },
    {
      "id": 2076512,
      "author": "Елена Демидова",
      "datetime": "2024-06-18T17:39:04.542647+03:00",
      "text": "Единственный момент, я не люблю когда параметры задаются внутри формулы. Думаю, как вытащить вот так (в заголовки столбцов накидала все параметры из XML подряд, просто чтобы посмотреть, что есть что и как работает):"
    },
    {
      "id": 2077885,
      "author": "Елена Демидова",
      "datetime": "2024-06-19T10:44:48.889987+03:00",
      "text": "Алексей, это реально проблема преобразования числа с точкой в дату и потом обратного её преобразования в число.\n\nПри чём:\n- числа с точками, которые датами быть не могут, возвращаются как значения с точками;\n- числа с точками, которые могут быть датами, преобразуются в даты в двух вариантах - ДД.ММ или ММ.ГГГГ;\n- числа без точек возвращаются как обычные числа.\n\nИтого мы имеем четыре варианта значений в ряду, для которых достаточно сложно придумать единую логику преобразования в корректные значения.\n\n В целом, автор начал логику по устранению этой ошибки, но его вариант просто меняет точку на запятую в уже преобразованных значениях. А менять точку на запятую после того, как произошло преобразование число/дата/число - поздно, надо лечить на более раннем этапе.\n\nПримерно так:\n\n=ФИЛЬТР.XML(ПОДСТАВИТЬ(ПОДСТАВИТЬ(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities.xml?iss.meta=off&amp;iss.only=marketdata&amp;marketdata.columns=SECID,LAST\");\".\";\",\");\",\";\",\";1);\"//document//data//rows//row[@SECID='\"&amp;A3&amp;\"']/@LAST\")\n\nТ.е. всё-таки сначала в полученном XML меняем точки на запятые, потом возвращаем первое вхождение запятой на точку (оно относится к версии XML и без точки ничего работать не будет) и только потом уже забираем нужные нам данные."
    },
    {
      "id": 2090051,
      "author": "Алексей Демченко",
      "datetime": "2024-06-25T13:28:00.672769+03:00",
      "text": "Елена, добрый день. Понял, но ваша формула у меня не сработала. А3 - это ячейка с тикером, верно? выдает \"#ЗНАЧ\""
    },
    {
      "id": 2119673,
      "author": "Михаил Шардин",
      "datetime": "2024-07-09T04:16:36.452081+03:00",
      "text": "Дмитрий, там по другому надо писать - если переписать код то тоже будет работать"
    },
    {
      "id": 2166196,
      "author": "Essa Sa",
      "datetime": "2024-08-01T16:36:49.396071+03:00",
      "text": "Вести свой учёт обязательно надо, после разнообразных мировых событий и делистингов тинькоф брокер просто удалил историю событий по некоторым бумагам. Вот тут то и пригодился файлик, где было записано сколько чего и почем покупалось! \nТекущие котировки не исследую, пока не вижу для себя смысла. Но информация очень полезная, спасибо. Наверняка когда нибудь дойду до этого уровня анализа😀"
    },
    {
      "id": 2186788,
      "author": "Вячеслав П",
      "datetime": "2024-08-15T11:06:53.180490+03:00",
      "text": "Михаил, подскажите, как нужно переписать код, чтобы котировки акций работали в Excel для macOS. Заранее спасибо!"
    },
    {
      "id": 2260919,
      "author": "user602892",
      "datetime": "2024-09-21T21:47:39.868841+03:00",
      "text": "Алексей, \nЕлена просто во второй замене оба раза поставила запятую, а надо сначала запятую , а потом точку, тогда все ок будет. Вот так \".\";\",\");\",\";\".\";1"
    },
    {
      "id": 2260921,
      "author": "user602892",
      "datetime": "2024-09-21T21:50:07.792238+03:00",
      "text": "Михаил, \nЕсли вдруг у кого то не заработает, то надо исправить ;\".\";\".\") на ;\".\";\",\")"
    },
    {
      "id": 2523588,
      "author": "Николай",
      "datetime": "2024-12-28T13:06:30.191900+03:00",
      "text": "Здравствуйте, все очень здорово! \nА есть аналогичные формулы для фондов?"
    },
    {
      "id": 2523631,
      "author": "Михаил Шардин",
      "datetime": "2024-12-28T13:26:07.899532+03:00",
      "text": "Николай, замените идентификатор режима торгов"
    },
    {
      "id": 2523865,
      "author": "Николай",
      "datetime": "2024-12-28T14:52:37.520436+03:00",
      "text": "Михаил, никак не получается подобрать правильную комбинацию к фонду ВИМ Ликвидность (LQDT):\n1. =ЕСЛИОШИБКА(ПОДСТАВИТЬ(ФИЛЬТР.XML(ВЕБСЛУЖБА(СЦЕПИТЬ(\"https://www.moex.com/iss/engines/stock/markets/shares/boards/TQTF/securities.xml?iss.meta=off&amp;iss.only=marketdata&amp;marketdata.columns=SECID,LAST\"));\"//document//data//rows//row[@SECID='\"&amp;A31&amp;\"']/@LAST\");\".\";\",\");\"\")\n\n2. =ЕСЛИОШИБКА(ПОДСТАВИТЬ(ФИЛЬТР.XML(ВЕБСЛУЖБА(СЦЕПИТЬ(\"https://www.moex.com/iss/engines/stock/markets/shares/boards/TQTF/securities.xml?iss.meta=off&amp;iss.only=securities&amp;securities.columns=SECID,PREVLEGALCLOSEPRICE\"));\"//document//data//rows//row[@SECID='\"&amp;A31&amp;\"']/@PREVLEGALCLOSEPRICE\");\".\";\",\");\"\")\n\nгде ячейка A31 - LQDT\n\nОба варианта выдают какое-то огромное значение. Причем с фондами от Альфы и Тинькофф такого не наблюдается:)"
    },
    {
      "id": 2620435,
      "author": "Эмиль К.",
      "datetime": "2025-01-31T17:50:36.456581+03:00",
      "text": "Отличный нужный пост. По следам неравнодушных комментаторов удалось всё отлично настроить. Теперь вопрос, реально ли так же настроить подгружать цены из секции OTC акции с ЦК (внебиржевой рынок) ? Сам пробовал настраивать, ни черта не получилось."
    },
    {
      "id": 2620442,
      "author": "Михаил Шардин",
      "datetime": "2025-01-31T17:52:34.282866+03:00",
      "text": "Эмиль, думаю возможно. Напишите мне. Через гугл мою сайт визитку можно найти"
    },
    {
      "id": 2641642,
      "author": "Михаил Шардин",
      "datetime": "2025-02-09T11:08:14.293549+03:00",
      "text": "Иван, в выходные у них всё по-другому работает. И иногда не работает"
    },
    {
      "id": 2651629,
      "author": "Михаил Шардин",
      "datetime": "2025-02-14T11:00:57.138480+03:00",
      "text": "Иван, таблица полностью от апи мосбиржи зависит что-то поменялось надо прямо конкретно пример что не работает"
    },
    {
      "id": 2654055,
      "author": "Михаил Шардин",
      "datetime": "2025-02-15T18:44:43.824157+03:00",
      "text": "Иван, через апи мосбиржи или апи Центробанка?"
    },
    {
      "id": 2659343,
      "author": "Дмитрий Тараленко",
      "datetime": "2025-02-18T16:48:49.584444+03:00",
      "text": "Денис, да. Я внизу написал. Только заменить @LEGALCLOSEPRICE на @CLOSE. И ещё один момент. Данные с биржи приходят в каком-то странном формате. То ли текст, то ли число. Т.е. арифметические действия с полученными данными делать можно, а вот график почему-то не строится. Что бы ещё и график строился нужно всю формулу умножить на 1."
    },
    {
      "id": 2665011,
      "author": "Дмитрий Тараленко",
      "datetime": "2025-02-21T12:08:35.504401+03:00",
      "text": "Денис, после вашего запроса (через Excel) биржа сначала (т.к. первый критерий поиска - это дата) выдаёт информацию на определенную дату по всему списку компаний в алфавитном порядке. А потом из этого списка по тикеру (второй критерий поиска) ищется конкретная, указанная нами, компания. Но компаний на бирже много, а биржа по каким-то причинам выдаёт исторические данные (почему-то именно исторические) дозировано, по 100 компаний за запрос. Т.е. первая сотня заканчивается где-то на Ленте, плюс-минус. Поэтому, если вам нужна информация, допустим, по Сберу, то Excel выдаст ошибку, т.к. в первой сотне её не будет. Поэтому мы отправляем второй запрос (start=100), в котором просим предоставить информацию о второй сотне компаний и уже в ней поискать информацию по Сберу. И т.д.\nОднако, если вам нужна текущая цена, то  здесь никаких ограничений нет, тот же Сбер очень даже легко находится сразу."
    },
    {
      "id": 2692395,
      "author": "Марина",
      "datetime": "2025-03-07T00:23:10.107395+03:00",
      "text": "Михаил, здравствуйте! А как в xls скачать список цб,торгующихся на МБ?"
    },
    {
      "id": 2692497,
      "author": "Михаил Шардин",
      "datetime": "2025-03-07T03:59:37.033708+03:00",
      "text": "Марина, через формулу не получится. Только скриптом"
    },
    {
      "id": 2693021,
      "author": "Марина",
      "datetime": "2025-03-07T11:52:56.009808+03:00",
      "text": "Михаил, хоть как, а то каждую их страницу из 365 с ума сойдешь копировать"
    },
    {
      "id": 2740920,
      "author": "Фарид Анварли",
      "datetime": "2025-03-31T07:14:36.010480+03:00",
      "text": "Подскажите пожалуйста, мне нужна информация не о цене, а показатели акции, конкретные, например капитал, долги и тп, что бы не писать мне их вручную, это модно сделать так же? Если да, то как должна выглядеть формула ?\n\nЗаранее благодарен."
    },
    {
      "id": 2740924,
      "author": "Михаил Шардин",
      "datetime": "2025-03-31T07:17:27.343220+03:00",
      "text": "Фарид, через АПИ Мосбиржи никак. \nЖдите выхода моей статьи на следующей неделе: https://habr.com/ru/articles/889932/\n\nТам описываю варианты."
    },
    {
      "id": 2741030,
      "author": "Фарид Анварли",
      "datetime": "2025-03-31T08:58:18.870763+03:00",
      "text": "Михаил, тогда жду с нетерпением"
    },
    {
      "id": 2818990,
      "author": "Виктория Акимова",
      "datetime": "2025-05-15T20:49:44.802858+03:00",
      "text": "Андрей, большое спасибо! А где еще посмотреть какие еще показатели можно скачать?"
    },
    {
      "id": 2819073,
      "author": "Виктория Акимова",
      "datetime": "2025-05-15T22:07:52.009180+03:00",
      "text": "Нашла, что режим торгов (примеры, TQCB, TCOB) для облигации (скорее всего и для акция и др.) можно получить по формуле\n=ФИЛЬТР.XML(ВЕБСЛУЖБА(\"https://iss.moex.com/iss/engines/stock/markets/bonds/securities/\"&amp;B2&amp;\"/securities.xml?iss.meta=off&amp;iss.only=marketdata&amp;marketdata.columns=BOARDID\");\"//document//data//rows//row/@BOARDID\")"
    },
    {
      "id": 2830889,
      "author": "user1762271",
      "datetime": "2025-05-22T15:32:41.464870+03:00",
      "text": "Спасибо за статью.\nПодскажите, пожалуйста, как получать котировки фьючерсов с Московской биржи?\nЗаранее спасибо."
    },
    {
      "id": 2857460,
      "author": "Андрей Мищенко",
      "datetime": "2025-06-06T11:24:20.551316+03:00",
      "text": "Полезные формулы, спасибо!"
    },
    {
      "id": 2865838,
      "author": "Наталья Семухина",
      "datetime": "2025-06-11T16:11:45.208780+03:00",
      "text": "user1762271, аналогично, ищу вариант для котировок фьючерсов"
    },
    {
      "id": 2896820,
      "author": "Эдуард Яковлев",
      "datetime": "2025-07-02T17:42:41.722735+03:00",
      "text": "Предпочитаю через Power query, формула \"Фильтр\" порой косячит на некоторых акциях и выдаёт левое число не имеющее отношение цене. Причём сегодня может дать адекватную цену, а завтра левую, от чего зависит не понятно. Power query чётко работает."
    },
    {
      "id": 2926635,
      "author": "Артём Курбатов",
      "datetime": "2025-07-20T16:09:02.142583+03:00",
      "text": ""
    },
    {
      "id": 2926848,
      "author": "Полиция Т—Ж",
      "datetime": "2025-07-20T19:17:50.837058+03:00",
      "text": "Артём, удалили ваш комментарий в соответствии с первым пунктом правил: https://t-j.ru/comments-rules/"
    },
    {
      "id": 3041342,
      "author": "Даниил Байша",
      "datetime": "2025-09-20T11:36:41.246381+03:00",
      "text": "Елена, огромное вам спасибо! Очень долго пытался решить эту проблему с датами, теперь всё заработало!"
    },
    {
      "id": 3052882,
      "author": "Сергей Куделин",
      "datetime": "2025-09-25T19:47:42.894984+03:00",
      "text": "не работает вкладка \"МИР\" там после нажатия enter отображаются нули вместо котировок"
    }
  ]
}